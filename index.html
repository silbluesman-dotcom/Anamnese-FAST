<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anamnese Fast - Silvestre Azevedo</title>

  <style>
    :root{
      --primary:#00695c;
      --light:#b2dfdb;
      --bg:#f5f7fa;
      --white:#ffffff;
      --alert:#d32f2f;
      --text:#333;
      --gray1:#616161;
      --gray2:#424242;
      --pdf:#0d47a1;
    }
    body{
      font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background:var(--bg);
      margin:0;
      padding:20px;
      color:var(--text);
    }
    .container{
      max-width:900px;
      margin:auto;
      background:var(--white);
      padding:30px;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,0.08);
      position:relative;
    }

    .header{
      text-align:center;
      margin-bottom:30px;
      border-bottom:2px solid var(--light);
      padding-bottom:20px;
    }
    .header h1{
      color:var(--primary);
      margin:0;
      font-size:2rem;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .author{
      color:#666;
      font-size:0.9rem;
      letter-spacing:1px;
      font-weight:600;
    }
    .profile-pic{
      width:80px;
      height:80px;
      border-radius:50%;
      border:3px solid var(--primary);
      margin-top:15px;
      object-fit:cover;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
    }

    .section-title{
      background:var(--primary);
      color:white;
      padding:10px 15px;
      border-radius:6px;
      margin-top:30px;
      margin-bottom:15px;
      font-weight:900;
      text-transform:uppercase;
      font-size:0.95rem;
    }

    .row{
      display:flex;
      gap:15px;
      flex-wrap:wrap;
      margin-bottom:15px;
    }
    .col{
      flex:1;
      min-width:200px;
    }

    .input-label{
      display:block;
      font-size:0.85rem;
      font-weight:800;
      color:#555;
      margin-bottom:5px;
    }
    .label-bold{
      font-weight:900;
      color:#111;
    }
    .label-alert{
      font-weight:900;
      color:var(--alert);
    }

    .input-field, select, textarea{
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
      box-sizing:border-box;
      font-family:inherit;
      font-size:0.95rem;
      background:#fafafa;
    }
    .input-field:focus, textarea:focus, select:focus{
      border-color:var(--primary);
      outline:none;
      background:#fff;
    }

    textarea{ resize:vertical; }

    .detail-input{
      display:none;
      margin-top:8px;
      border-left:3px solid var(--primary);
      padding-left:10px;
      background:#fff;
    }

    .toggle-group{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .toggle-btn{
      border:1px solid #ccc;
      background:#e0e0e0;
      padding:8px 18px;
      border-radius:20px;
      cursor:pointer;
      font-size:0.85rem;
      user-select:none;
      transition:0.2s;
      font-weight:900;
    }
    .toggle-btn:hover{ background:#d0d0d0; }
    .toggle-btn.active{
      background:var(--primary);
      color:white;
      border-color:var(--primary);
      box-shadow:0 2px 5px rgba(0,105,92,0.3);
    }
    .toggle-btn.alert-active{
      background:var(--alert);
      border-color:var(--alert);
      color:white;
    }

    .vitals-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(130px, 1fr));
      gap:12px;
    }
    .vital-box input{
      text-align:center;
      font-weight:900;
      color:var(--primary);
      font-size:1.05rem;
    }
    .vital-box .input-label{
      white-space:nowrap;
    }

    .action-area{
      margin-top:40px;
      display:flex;
      gap:15px;
      flex-wrap:wrap;
    }
    .btn-generate{
      flex:2;
      background:linear-gradient(135deg, #00695c 0%, #004d40 100%);
      color:white;
      padding:20px;
      border:none;
      border-radius:10px;
      font-size:1.05rem;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(0,77,64,0.3);
      transition:transform 0.2s;
    }
    .btn-generate:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(0,77,64,0.35);
    }

    .btn-reset{
      flex:1;
      background:linear-gradient(135deg, var(--gray1) 0%, var(--gray2) 100%);
      color:white;
      padding:20px;
      border:none;
      border-radius:10px;
      font-size:1.05rem;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(0,0,0,0.18);
      transition:transform 0.2s;
    }
    .btn-reset:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(0,0,0,0.22);
    }

    .modal{
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      z-index:1000;
      justify-content:center;
      align-items:center;
      backdrop-filter:blur(2px);
    }
    .modal-content{
      background:white;
      width:92%;
      max-width:900px;
      height:88vh;
      padding:22px;
      border-radius:12px;
      display:flex;
      flex-direction:column;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }
    #finalReport{
      flex:1;
      font-family:"Courier New", monospace;
      padding:15px;
      font-size:0.95rem;
      resize:none;
      margin-bottom:12px;
      border:1px solid #ddd;
      border-radius:6px;
      background:#f9f9f9;
      line-height:1.4;
      white-space:pre-wrap;
    }

    .modal-actions{
      display:flex;
      gap:15px;
      flex-wrap:wrap;
    }
    .btn-modal{
      flex:1;
      padding:15px;
      border:none;
      border-radius:8px;
      font-weight:900;
      cursor:pointer;
      color:white;
      font-size:1rem;
      min-width:160px;
    }
    .btn-copy{ background:var(--primary); }
    .btn-pdf{ background:var(--pdf); }
    .btn-close{ background:var(--alert); }

    @media print {
      body { margin: 0; padding: 0; }
      .print-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 10px 20px;
        border-bottom: 2px solid #00695c;
        z-index: 1000;
      }
      .print-content {
        margin-top: 120px;
        padding: 20px;
        margin-bottom: 80px;
        page-break-inside: avoid;
      }
      .print-line {
        page-break-inside: avoid;
        margin-bottom: 8px;
      }
      .print-footer {
        position: fixed;
        right: 0;
        bottom: 0;
        padding: 8px 20px;
        font-size: 9pt;
        color: #424242;
      }
    }
/* ALERTA DE AUTO-SAVE */
.autosave-alert {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  color: white;
  padding: 16px 20px;
  border-radius: 10px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  z-index: 9999;
  display: none;
  max-width: 90%;
  text-align: center;
}

.autosave-alert.show {
  display: block;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.autosave-alert p {
  margin: 0 0 10px 0;
  font-weight: 700;
  font-size: 0.95rem;
}

.autosave-alert-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.autosave-alert-actions button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 800;
  font-size: 0.85rem;
  transition: transform 0.2s;
}

.autosave-alert-actions button:hover {
  transform: translateY(-2px);
}

.btn-restore {
  background: #4caf50;
  color: white;
}

.btn-discard {
  background: #f44336;
  color: white;
}

/* HIST√ìRICO DE PACIENTES */
.btn-historico {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary) 0%, #004d40 100%);
  color: white;
  border: none;
  cursor: pointer;
  font-size: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 999;
  transition: transform 0.2s;
}

.btn-historico:hover {
  transform: scale(1.1);
}

.modal-historico {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 9998;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(2px);
}

.modal-historico.show {
  display: flex;
}

.modal-historico-content {
  background: white;
  width: 92%;
  max-width: 700px;
  max-height: 85vh;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-historico-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--light);
}

.modal-historico-header h2 {
  margin: 0;
  color: var(--primary);
  font-size: 1.3rem;
}

.btn-fechar-historico {
  background: var(--alert);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 800;
  font-size: 0.85rem;
}

.search-box {
  margin-bottom: 16px;
}

.search-box input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 1rem;
  box-sizing: border-box;
}

.search-box input:focus {
  border-color: var(--primary);
  outline: none;
}

.lista-pacientes {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 12px;
}

.paciente-item {
  background: #f9f9f9;
  border-left: 4px solid var(--primary);
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.paciente-item:hover {
  background: #f0f0f0;
  transform: translateX(4px);
}

.paciente-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.paciente-nome {
  font-weight: 800;
  color: var(--primary);
  font-size: 1.05rem;
}

.paciente-data {
  font-size: 0.8rem;
  color: #666;
  font-weight: 600;
}

.paciente-info {
  font-size: 0.85rem;
  color: #555;
  margin-bottom: 8px;
}

.paciente-actions {
  display: flex;
  gap: 8px;
}

.paciente-actions button {
  flex: 1;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.8rem;
  transition: transform 0.2s;
}

.paciente-actions button:hover {
  transform: translateY(-2px);
}

.btn-carregar {
  background: var(--primary);
  color: white;
}

.btn-excluir {
  background: var(--alert);
  color: white;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-state p {
  font-size: 1.1rem;
  margin: 10px 0;
}

.pacientes-count {
  font-size: 0.85rem;
  color: #666;
  margin-bottom: 12px;
  font-weight: 600;
}

    /* LOGIN overlay */
    #loginOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      backdrop-filter: blur(2px);
    }
    #loginBox{
      width: 92%;
      max-width: 420px;
      background: var(--white);
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.30);
      text-align: center;
    }
    #loginBox h2{
      margin: 0 0 8px;
      color: var(--primary);
      font-weight: 900;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-size: 1.1rem;
    }
    #loginBox p{
      margin: 0 0 14px;
      color: var(--gray1);
      font-weight: 700;
      font-size: 0.9rem;
    }
#loginBox .toggle-link {
  margin-top: 12px;
  font-size: 0.85rem;
  color: var(--primary);
  cursor: pointer;
  text-decoration: underline;
}

#loginBox .toggle-link:hover {
  color: #004d40;
}

#loginBox input {
  margin-bottom: 10px;
}

#loginBox .reset-info {
  margin-top: 10px;
  font-size: 0.75rem;
  color: #999;
}
    #loginSenha{
      width: 100%;
      padding: 14px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 1rem;
      text-align: center;
      outline: none;
      background: #fafafa;
      box-sizing: border-box;
    }
    #loginSenha:focus{
      border-color: var(--primary);
      background: #fff;
    }
    #loginEntrar{
      width: 100%;
      margin-top: 12px;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-weight: 900;
      cursor: pointer;
      background: linear-gradient(135deg, #00695c 0%, #004d40 100%);
      color: white;
    }
    #loginErro{
      display:none;
      margin-top: 10px;
      color: var(--alert);
      font-weight: 900;
      font-size: 0.85rem;
    }

    /* Emoji nos r√≥tulos */
    .emoji-icon{
      display:inline-block;
      width:1.2em;
      text-align:center;
      margin-right:4px;
      font-size:1.1rem;
      vertical-align:middle;
    }
        /* ============ ESPECIALIDADES - NOVO ============ */
    .btn-especialidades {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #00695c 0%, #004d40 100%);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 900;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,105,92,0.3);
      transition: all 0.3s;
      z-index: 100;
    }
    .btn-especialidades:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,105,92,0.4);
    }

    .modal-especialidades {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal-especialidades.active {
      display: flex;
    }
    .modal-content-esp {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .modal-content-esp h2 {
      margin: 0 0 20px;
      color: var(--primary);
      font-size: 1.5rem;
      text-align: center;
    }
    .especialidade-item {
      padding: 15px;
      margin: 10px 0;
      background: var(--light);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.2s;
      text-align: center;
    }
    .especialidade-item:hover {
      background: var(--primary);
      color: white;
      transform: translateX(5px);
    }
    .btn-fechar-modal {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background: var(--gray1);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }

    .secao-especializada {
      display: none;
      margin-top: 30px;
      border-top: 3px solid var(--primary);
      padding-top: 20px;
    }
    .secao-especializada.active {
      display: block;
    }
    .badge-especialidade {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 900;
      margin-bottom: 20px;
    }

    .checkbox-group {
      margin: 10px 0;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      cursor: pointer;
    }
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    .checkbox-item label {
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .checkbox-subitem {
      margin-left: 35px;
    }

  </style>
</head>

<body>
 <div id="loginOverlay" aria-hidden="false">
    <div id="loginBox">
        <h2>Anamnese Fast</h2>
        
        <!-- TELA DE LOGIN -->
        <div id="telaLogin">
            <p><strong>Seja bem-vindo, √≥timo dia de trabalho!</strong></p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Entre com suas credenciais</p>
            <input id="loginUsuario" type="text" placeholder="Usu√°rio" autocomplete="username">
            <input id="loginSenha" type="password" placeholder="Senha" autocomplete="current-password">
            <button id="loginEntrar" type="button">Entrar</button>
            <div id="loginErro" style="display: none; margin-top: 10px; color: var(--alert); font-weight: 900; font-size: 0.85rem;">Usu√°rio ou senha incorretos.</div>
            <div class="toggle-link" onclick="mostrarReset()">Esqueci minha senha / Resetar credenciais</div>
        </div>
        
        <!-- TELA DE CADASTRO (primeira vez) -->
        <div id="telaCadastro" style="display: none;">
            <p><strong>Primeira vez aqui! Crie suas credenciais:</strong></p>
            <input id="cadastroUsuario" type="text" placeholder="Escolha um usu√°rio" autocomplete="username">
            <input id="cadastroSenha" type="password" placeholder="Escolha uma senha" autocomplete="new-password">
            <input id="cadastroSenhaConfirm" type="password" placeholder="Confirme a senha" autocomplete="new-password">
            <button id="cadastroBotao" type="button">Criar conta</button>
            <div id="cadastroErro" style="display: none; margin-top: 10px; color: var(--alert); font-weight: 900; font-size: 0.85rem;"></div>
        </div>
        
        <!-- TELA DE RESET -->
        <div id="telaReset" style="display: none;">
            <p><strong>Resetar credenciais</strong></p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Isso apagar√° seu usu√°rio e senha atuais.</p>
            <button id="resetConfirmar" type="button" style="background: var(--alert);">Confirmar reset</button>
            <div class="toggle-link" onclick="voltarLogin()">Cancelar</div>
            <div class="reset-info">‚ö†Ô∏è Aten√ß√£o: O hist√≥rico de pacientes ser√° mantido, apenas as credenciais ser√£o apagadas.</div>
        </div>
    </div>
</div>

<!-- ALERTA DE AUTO-SAVE -->
<div id="autosaveAlert" class="autosave-alert">
  <p>üìã Dados salvos encontrados! Deseja restaurar?</p>
  <div class="autosave-alert-actions">
    <button class="btn-restore" onclick="restaurarAutosave()">Restaurar</button>
    <button class="btn-discard" onclick="descartarAutosave()">Come√ßar do zero</button>
  </div>
</div>

<!-- BOT√ÉO FLUTUANTE DE HIST√ìRICO -->
<button id="btnHistorico" class="btn-historico" title="Hist√≥rico de Pacientes">
  üìã
</button>

<!-- MODAL DE HIST√ìRICO -->
<div id="modalHistorico" class="modal-historico">
  <div class="modal-historico-content">
    <div class="modal-historico-header">
      <h2>üìã Hist√≥rico de Pacientes</h2>
      <button class="btn-fechar-historico" onclick="fecharHistorico()">Fechar</button>
    </div>

    <div class="search-box">
      <input type="text" id="searchPaciente" placeholder="üîç Buscar por nome do paciente...">
    </div>

    <div class="pacientes-count" id="pacientesCount">
      0 pacientes salvos
    </div>

    <div class="lista-pacientes" id="listaPacientes">
      <div class="empty-state">
        <p>üì≠</p>
        <p>Nenhum paciente salvo ainda</p>
      </div>
    </div>
  </div>
</div>

  <div class="container">
        <!-- BOT√ÉO ESPECIALIDADES -->
    <button class="btn-especialidades" onclick="abrirModalEspecialidades()">
      üè• Especialidades ‚ñº
    </button>

    <div class="header">
      <h1>Anamnese Fast</h1>
      <span class="author">Desenvolvido por: Silvestre Azevedo - Acad√™mico de Medicina</span>
      <div style="text-align:center;">
        <!-- ajuste para Flask -->
        <img src="/static/perfil.jpg" class="profile-pic" onerror="this.style.display='none'" alt="Foto perfil" />
      </div>
    </div>

<div class="row" style="margin-top: 10px;">
      <div class="col">
        <span class="input-label label-bold" style="color:var(--primary);">RESPONS√ÅVEL PELO ATENDIMENTO</span>
        <input type="text" id="responsavel" class="input-field" placeholder="Seu nome completo (Ex: Dr. Silvestre Azevedo)" />
      </div>
    </div>
    <div class="section-title">Admiss√£o / Evolu√ß√£o</div>

    <div class="row">
      <div class="col">
        <span class="input-label label-bold">PACIENTE</span>
        <input type="text" id="nome" class="input-field" placeholder="Nome do paciente" />
      </div>
      <div class="col" style="flex:0.35;">
        <span class="input-label label-bold">IDADE</span>
        <input type="number" id="idade" class="input-field" placeholder="anos" />
      </div>
      <div class="col" style="flex:0.35;">
        <span class="input-label label-bold">SEXO</span>
        <select id="sexo" class="input-field">
          <option value="M" selected>M</option>
          <option value="F">F</option>
        </select>
      </div>
      <div class="col">
        <span class="input-label label-bold">RELIGI√ÉO</span>
        <input type="text" id="religiao" class="input-field" value="" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <span class="input-label label-bold">UNIDADE / SETOR</span>
        <input type="text" id="unidade" class="input-field" placeholder="Ex.: PS / UTI / Enfermaria / UBS" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <span class="input-label label-alert">ALERGIAS MEDICAMENTOSAS</span>
        <div class="toggle-group" id="alergias-group">
          <div class="toggle-btn active" onclick="setOption('alergias','N√£o')">N√ÉO</div>
          <div class="toggle-btn" onclick="setOption('alergias','Sim')">SIM</div>
        </div>
        <input type="text" id="alergias-detalhe" class="input-field detail-input" placeholder="Quais medicamentos? (IMPORTANTE)" />
      </div>

      <div class="col">
        <span class="input-label label-alert">INTERNA√á√ÉO NOS √öLTIMOS 3 MESES?</span>
        <div class="toggle-group" id="internacao-group">
          <div class="toggle-btn active" onclick="setOption('internacao','N√£o')">N√ÉO</div>
          <div class="toggle-btn" onclick="setOption('internacao','Sim')">SIM</div>
        </div>
        <input type="text" id="internacao-detalhe" class="input-field detail-input" placeholder="Motivo / onde / datas (se souber)" />
      </div>
    </div>

    <div class="row">
      <div class="col" style="flex-basis:100%;">
        <span class="input-label label-bold">H√ÅBITOS DE VIDA</span>
      </div>

      <!-- TABAGISMO COM C√ÅLCULO -->
      <div class="col">
        <span class="input-label">Tabagismo</span>
        <div class="toggle-group" id="tabagismo-group">
          <div class="toggle-btn active" onclick="setOption('tabagismo','N√£o')">N√ÉO</div>
          <div class="toggle-btn" onclick="setOption('tabagismo','Sim')">SIM</div>
        </div>

        <input type="text" id="tabagismo-detalhe"
               class="input-field detail-input"
               placeholder="Qtd / frequ√™ncia / ma√ßos-ano" />

        <div id="tabagismo-calc" class="detail-input">
          <div style="margin-top:8px; font-size:0.8rem; font-weight:700;">
            C√°lculo da carga tab√°gica:
          </div>
          <div class="row" style="margin-top:5px; gap:8px;">
            <div class="col">
              <span class="input-label">Cigarros/dia</span>
              <input type="number" id="tab_cigs_dia" class="input-field" min="0"
                     oninput="calcularCargaTabagica()" />
            </div>
            <div class="col">
              <span class="input-label">Anos fumando</span>
              <input type="number" id="tab_anos" class="input-field" min="0" step="0.5"
                     oninput="calcularCargaTabagica()" />
            </div>
          </div>
          <div style="margin-top:6px; font-size:0.85rem; font-weight:800;">
            Carga tab√°gica (ma√ßos-ano):
            <span id="tab_carga" style="color:var(--primary);">0</span>
          </div>
        </div>
      </div>

      <div class="col">
        <span class="input-label">Etilismo</span>
        <div class="toggle-group" id="etilismo-group">
          <div class="toggle-btn active" onclick="setOption('etilismo','N√£o')">N√ÉO</div>
          <div class="toggle-btn" onclick="setOption('etilismo','Sim')">SIM</div>
        </div>
        <input type="text" id="etilismo-detalhe" class="input-field detail-input" placeholder="Qtd / frequ√™ncia / tempo de uso" />
      </div>

      <div class="col">
        <span class="input-label">Drogas il√≠citas</span>
        <div class="toggle-group" id="drogas-group">
          <div class="toggle-btn active" onclick="setOption('drogas','N√£o')">N√ÉO</div>
          <div class="toggle-btn" onclick="setOption('drogas','Sim')">SIM</div>
        </div>
        <input type="text" id="drogas-detalhe" class="input-field detail-input" placeholder="Qual subst√¢ncia / padr√£o de uso" />
      </div>
    </div>

    <div class="section-title">Hist√≥ria</div>

    <span class="input-label label-bold">QUEIXA PRINCIPAL (QP)</span>
    <input type="text" id="qp" class="input-field" style="margin-bottom:10px;" placeholder="Descreva a QP" />

    <span class="input-label label-bold">HIST√ìRIA DA DOEN√áA ATUAL (HDA)</span>
    <textarea id="hda" rows="4" placeholder="Descreva a HDA..."></textarea>

    <div class="row">
      <div class="col">
        <span class="input-label label-bold">HIST√ìRIA PATOL√ìGICA PREGRESSA (HPP)</span>
        <textarea id="hpp" rows="3" placeholder="Comorbidades, cirurgias, interna√ß√µes pr√©vias, uso cr√¥nico de medicamentos etc."></textarea>
      </div>
      <div class="col">
        <span class="input-label label-bold">MEDICAMENTOS DE USO CONT√çNUO</span>
        <textarea id="meds_continuos" rows="3" placeholder="01 - "></textarea>
      </div>
    </div>

    <div class="row">
  <div class="col">
    <span class="input-label label-bold">HIST√ìRIA FAMILIAR (HF)</span>
    <textarea id="hf" rows="3" placeholder="Doen√ßas na fam√≠lia, causas de √≥bito relevantes, doen√ßas heredit√°rias etc."></textarea>
  </div>
  <div class="col">
    <span class="input-label label-bold">EXAMES LABORATORIAIS</span>
    <textarea id="labs" rows="3" placeholder="Cole/registre aqui os resultados (hemograma, eletr√≥litos, gaso, etc.)."></textarea>
  </div>
</div>

<div class="row">
  <div class="col">
    <span class="input-label label-bold">EXAMES DE IMAGEM</span>
    <textarea id="imagem" rows="3"
      placeholder="Laudos e principais achados de RX, TC, RM, USG, eco, etc."></textarea>
  </div>
</div>

    <div class="section-title">Exame F√≠sico</div>

    <span class="input-label label-bold">Sinais Vitais</span>
    <div class="vitals-grid" style="margin-bottom:12px;">
      <div class="vital-box">
        <span class="input-label">
          <span class="emoji-icon" role="img" aria-label="press√£o arterial">ü©∫</span>
          PA (mmHg)
        </span>
        <input type="text" id="pa" class="input-field" placeholder="120x80" />
      </div>
      <div class="vital-box">
        <span class="input-label">
          <span class="emoji-icon" role="img" aria-label="frequ√™ncia card√≠aca">‚ù§Ô∏è</span>
          FC (bpm)
        </span>
        <input type="number" id="fc" class="input-field" placeholder="80" />
      </div>
      <div class="vital-box">
        <span class="input-label">
          <span class="emoji-icon" role="img" aria-label="frequ√™ncia respirat√≥ria">ü´Å</span>
          FR (ipm)
        </span>
        <input type="number" id="fr" class="input-field" placeholder="18" />
      </div>
      <div class="vital-box">
        <span class="input-label">
          <span class="emoji-icon" role="img" aria-label="satura√ß√£o de oxig√™nio">ü©∏</span>
          SatO2 (%)
        </span>
        <input type="number" id="sat" class="input-field" placeholder="98" />
      </div>
      <div class="vital-box">
        <span class="input-label">
          <span class="emoji-icon" role="img" aria-label="temperatura">üå°Ô∏è</span>
          T (¬∞C)
        </span>
        <input type="number" step="0.1" id="temp" class="input-field" placeholder="36.5" />
      </div>
      <div class="vital-box">
        <span class="input-label">
          <span class="emoji-icon" role="img" aria-label="glicemia capilar">üç¨</span>
          Glicemia (mg/dL)
        </span>
        <input type="number" id="hgt" class="input-field" placeholder="100" />
      </div>
    </div>

    <div class="section-title">Ectoscopia e Segmentar</div>

    <span class="input-label label-bold">ECTOSCOPIA</span>
    <textarea id="ef_ectoscopia" rows="3"></textarea>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <span class="input-label label-bold">Cabe√ßa e pesco√ßo</span>
        <textarea id="ef_cp" rows="3"></textarea>
      </div>
      <div class="col">
        <span class="input-label label-bold">ACV</span>
        <textarea id="ef_acv" rows="3"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <span class="input-label label-bold">AP</span>
        <textarea id="ef_ap" rows="3"></textarea>
      </div>
      <div class="col">
        <span class="input-label label-bold">ABD</span>
        <textarea id="ef_abd" rows="3"></textarea>
      </div>
    </div>

    <span class="input-label label-bold">NEURO</span>
    <textarea id="ef_neuro" rows="3"></textarea>

    <span class="input-label label-bold" style="margin-top:10px;">MEMBROS</span>
    <textarea id="ef_membros" rows="2"></textarea>

    <div class="section-title">Exame Neurol√≥gico Detalhado</div>
    <textarea id="neuro_detalhado" rows="10"></textarea>

    <div class="action-area">
            <!-- ============ SE√á√ÉO ESPECIALIZADA - GASTROENTEROLOGIA ============ -->
    <div id="secao-gastro" class="secao-especializada">
      <span class="badge-especialidade">üè• ANAMNESE - GASTROENTEROLOGIA</span>

      <div class="section-title">üî• 3. Dor Abdominal</div>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="dor-abdominal" onchange="toggleDorAbdominal()">
          <label for="dor-abdominal">Apresenta dor abdominal</label>
        </div>
      </div>

      <div id="dor-abdominal-detalhes" style="display:none; margin-left:20px;">
        <span class="input-label label-bold">Localiza√ß√£o</span>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="loc-epigastrio"><label for="loc-epigastrio">Epig√°strio</label></div>
          <div class="checkbox-item"><input type="checkbox" id="loc-hd"><label for="loc-hd">Hipoc√¥ndrio direito</label></div>
          <div class="checkbox-item"><input type="checkbox" id="loc-he"><label for="loc-he">Hipoc√¥ndrio esquerdo</label></div>
          <div class="checkbox-item"><input type="checkbox" id="loc-peri"><label for="loc-peri">Periumbilical</label></div>
          <div class="checkbox-item"><input type="checkbox" id="loc-fid"><label for="loc-fid">Fossa il√≠aca direita</label></div>
          <div class="checkbox-item"><input type="checkbox" id="loc-fie"><label for="loc-fie">Fossa il√≠aca esquerda</label></div>
          <div class="checkbox-item"><input type="checkbox" id="loc-difusa"><label for="loc-difusa">Difusa</label></div>
        </div>

        <span class="input-label label-bold">Tipo</span>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="tipo-queimacao"><label for="tipo-queimacao">Queima√ß√£o</label></div>
          <div class="checkbox-item"><input type="checkbox" id="tipo-colica"><label for="tipo-colica">C√≥lica</label></div>
          <div class="checkbox-item"><input type="checkbox" id="tipo-peso"><label for="tipo-peso">Peso</label></div>
          <div class="checkbox-item"><input type="checkbox" id="tipo-pontada"><label for="tipo-pontada">Pontada</label></div>
        </div>

        <span class="input-label label-bold">Intensidade</span>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="int-leve"><label for="int-leve">Leve</label></div>
          <div class="checkbox-item"><input type="checkbox" id="int-moderada"><label for="int-moderada">Moderada</label></div>
          <div class="checkbox-item"><input type="checkbox" id="int-intensa"><label for="int-intensa">Intensa</label></div>
        </div>

        <span class="input-label label-bold">Irradia√ß√£o</span>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="irrad-dorso"><label for="irrad-dorso">Dorso</label></div>
          <div class="checkbox-item"><input type="checkbox" id="irrad-ombro"><label for="irrad-ombro">Ombro direito</label></div>
          <div class="checkbox-item"><input type="checkbox" id="irrad-nao"><label for="irrad-nao">N√£o irradia</label></div>
        </div>

        <span class="input-label label-bold">Rela√ß√£o</span>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="rel-piora-alim"><label for="rel-piora-alim">Piora ap√≥s alimenta√ß√£o</label></div>
          <div class="checkbox-item"><input type="checkbox" id="rel-jejum"><label for="rel-jejum">Melhora em jejum</label></div>
          <div class="checkbox-item"><input type="checkbox" id="rel-evac"><label for="rel-evac">Melhora ap√≥s evacua√ß√£o</label></div>
          <div class="checkbox-item"><input type="checkbox" id="rel-noturna"><label for="rel-noturna">Dor noturna</label></div>
        </div>
      </div>

      <div class="section-title">üîº 4. Sintomas Digestivos Altos</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="azia"><label for="azia">Azia / Pirose</label></div>
        <div class="checkbox-item"><input type="checkbox" id="regurg"><label for="regurg">Regurgita√ß√£o</label></div>
        <div class="checkbox-item"><input type="checkbox" id="nauseas"><label for="nauseas">N√°useas</label></div>
        <div class="checkbox-item">
          <input type="checkbox" id="vomitos" onchange="toggleVomitos()">
          <label for="vomitos">V√¥mitos</label>
        </div>
        <div id="vomitos-detalhes" style="display:none;" class="checkbox-subitem">
          <div class="checkbox-item"><input type="checkbox" id="vom-alim"><label for="vom-alim">Alimentares</label></div>
          <div class="checkbox-item"><input type="checkbox" id="vom-bil"><label for="vom-bil">Biliosos</label></div>
          <div class="checkbox-item"><input type="checkbox" id="vom-sangue"><label for="vom-sangue">Com sangue (hemat√™mese)</label></div>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="disfagia" onchange="toggleDisfagia()">
          <label for="disfagia">Disfagia</label>
        </div>
        <div id="disfagia-detalhes" style="display:none;" class="checkbox-subitem">
          <div class="checkbox-item"><input type="checkbox" id="disf-sol"><label for="disf-sol">S√≥lidos</label></div>
          <div class="checkbox-item"><input type="checkbox" id="disf-liq"><label for="disf-liq">L√≠quidos</label></div>
          <div class="checkbox-item"><input type="checkbox" id="disf-ambos"><label for="disf-ambos">Ambos</label></div>
        </div>
        <div class="checkbox-item"><input type="checkbox" id="odinofagia"><label for="odinofagia">Odinofagia</label></div>
        <div class="checkbox-item"><input type="checkbox" id="saciedade"><label for="saciedade">Saciedade precoce</label></div>
        <div class="checkbox-item"><input type="checkbox" id="plenitude"><label for="plenitude">Plenitude p√≥s-prandial</label></div>
      </div>

      <div class="section-title">üîΩ 5. Sintomas Digestivos Baixos</div>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="diarreia" onchange="toggleDiarreia()">
          <label for="diarreia">Diarreia</label>
        </div>
        <div id="diarreia-detalhes" style="display:none;" class="checkbox-subitem">
          <div class="checkbox-item"><input type="checkbox" id="diarr-aguda"><label for="diarr-aguda">Aguda</label></div>
          <div class="checkbox-item"><input type="checkbox" id="diarr-cronica"><label for="diarr-cronica">Cr√¥nica</label></div>
        </div>
        <div class="checkbox-item"><input type="checkbox" id="constipacao"><label for="constipacao">Constipa√ß√£o</label></div>
        <div class="checkbox-item"><input type="checkbox" id="alternancia"><label for="alternancia">Altern√¢ncia diarreia/constipa√ß√£o</label></div>
        <div class="checkbox-item"><input type="checkbox" id="tenesmo"><label for="tenesmo">Tenesmo</label></div>
        <div class="checkbox-item"><input type="checkbox" id="urgencia"><label for="urgencia">Urg√™ncia evacuat√≥ria</label></div>
      </div>

      <div class="section-title">üí© 6. Caracter√≠sticas das Fezes</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="fezes-normais"><label for="fezes-normais">Normais</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-pastosas"><label for="fezes-pastosas">Pastosas</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-liquidas"><label for="fezes-liquidas">L√≠quidas</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-duras"><label for="fezes-duras">Endurecidas</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-melena"><label for="fezes-melena">Escuras (melena)</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-sangue"><label for="fezes-sangue">Com sangue vivo</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-muco"><label for="fezes-muco">Com muco</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-oleosas"><label for="fezes-oleosas">Oleosas / brilhantes (esteatorreia)</label></div>
      </div>

      <div class="section-title">üü° 7. Icter√≠cia / Hepatobiliar</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="ict-olhos"><label for="ict-olhos">Olhos amarelados</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ict-pele"><label for="ict-pele">Pele amarelada</label></div>
        <div class="checkbox-item"><input type="checkbox" id="urina-escura"><label for="urina-escura">Urina escura</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fezes-claras"><label for="fezes-claras">Fezes claras</label></div>
        <div class="checkbox-item"><input type="checkbox" id="prurido"><label for="prurido">Prurido</label></div>
        <div class="checkbox-item"><input type="checkbox" id="dor-hd-gastro"><label for="dor-hd-gastro">Dor em hipoc√¥ndrio direito</label></div>
      </div>

      <div class="section-title">üå°Ô∏è 8. Sintomas Sist√™micos</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="febre-gastro"><label for="febre-gastro">Febre</label></div>
        <div class="checkbox-item"><input type="checkbox" id="perda-peso"><label for="perda-peso">Perda de peso involunt√°ria</label></div>
        <div class="checkbox-item"><input type="checkbox" id="anorexia-gastro"><label for="anorexia-gastro">Anorexia</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fadiga-gastro"><label for="fadiga-gastro">Fadiga</label></div>
        <div class="checkbox-item"><input type="checkbox" id="sudorese"><label for="sudorese">Sudorese noturna</label></div>
      </div>

      <div class="section-title">üè• 9. Antecedentes Gastrointestinais</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="ant-gastrite"><label for="ant-gastrite">Gastrite</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-drge"><label for="ant-drge">DRGE</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-ulcera"><label for="ant-ulcera">√ölcera p√©ptica</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-hepatite"><label for="ant-hepatite">Hepatite</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-cirrose"><label for="ant-cirrose">Cirrose</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-colel"><label for="ant-colel">Colelit√≠ase</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-panc"><label for="ant-panc">Pancreatite</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-crohn"><label for="ant-crohn">Doen√ßa de Crohn</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-rcu"><label for="ant-rcu">Retocolite Ulcerativa</label></div>
        <div class="checkbox-item"><input type="checkbox" id="ant-cirurg"><label for="ant-cirurg">Cirurgia abdominal pr√©via</label></div>
      </div>

      <div class="section-title">üíä 10. Uso de Medicamentos</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="med-aines"><label for="med-aines">AINEs</label></div>
        <div class="checkbox-item"><input type="checkbox" id="med-cortic"><label for="med-cortic">Corticoides</label></div>
        <div class="checkbox-item"><input type="checkbox" id="med-atb"><label for="med-atb">Antibi√≥ticos recentes</label></div>
        <div class="checkbox-item"><input type="checkbox" id="med-ibp"><label for="med-ibp">IBP / Anti√°cidos</label></div>
        <div class="checkbox-item"><input type="checkbox" id="med-lax"><label for="med-lax">Laxantes</label></div>
        <div class="checkbox-item"><input type="checkbox" id="med-fito"><label for="med-fito">Fitoter√°picos</label></div>
      </div>

      <div class="section-title">üç∫ 11. H√°bitos de Vida</div>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="hab-etil" onchange="toggleEtilismoGastro()">
          <label for="hab-etil">Etilismo</label>
        </div>
        <div id="etilismo-detalhes-gastro" style="display:none;" class="checkbox-subitem">
          <div class="checkbox-item"><input type="checkbox" id="etil-social"><label for="etil-social">Social</label></div>
          <div class="checkbox-item"><input type="checkbox" id="etil-freq"><label for="etil-freq">Frequente</label></div>
          <div class="checkbox-item"><input type="checkbox" id="etil-pesado"><label for="etil-pesado">Pesado</label></div>
        </div>
        <div class="checkbox-item"><input type="checkbox" id="hab-tab"><label for="hab-tab">Tabagismo</label></div>
        <div class="checkbox-item"><input type="checkbox" id="hab-drogas"><label for="hab-drogas">Drogas il√≠citas</label></div>
        <div class="checkbox-item"><input type="checkbox" id="hab-gord"><label for="hab-gord">Dieta rica em gordura</label></div>
        <div class="checkbox-item"><input type="checkbox" id="hab-lact"><label for="hab-lact">Consumo excessivo de lactose</label></div>
        <div class="checkbox-item"><input type="checkbox" id="hab-gluten"><label for="hab-gluten">Consumo de gl√∫ten</label></div>
      </div>

      <div class="section-title">üë®‚Äçüë©‚Äçüëß 12. Antecedentes Familiares</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="fam-cancer"><label for="fam-cancer">C√¢ncer gastrointestinal</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fam-dii"><label for="fam-dii">Doen√ßa inflamat√≥ria intestinal</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fam-hepat"><label for="fam-hepat">Doen√ßa hep√°tica</label></div>
        <div class="checkbox-item"><input type="checkbox" id="fam-polipose"><label for="fam-polipose">Polipose familiar</label></div>
      </div>

      <div class="section-title">üö® 13. Sinais de Alarme</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="alarm-peso"><label for="alarm-peso">Perda de peso inexplicada</label></div>
        <div class="checkbox-item"><input type="checkbox" id="alarm-anemia"><label for="alarm-anemia">Anemia</label></div>
        <div class="checkbox-item"><input type="checkbox" id="alarm-sangr"><label for="alarm-sangr">Sangramento digestivo</label></div>
        <div class="checkbox-item"><input type="checkbox" id="alarm-disf"><label for="alarm-disf">Disfagia progressiva</label></div>
        <div class="checkbox-item"><input type="checkbox" id="alarm-vom"><label for="alarm-vom">V√¥mitos persistentes</label></div>
        <div class="checkbox-item"><input type="checkbox" id="alarm-dor"><label for="alarm-dor">Dor abdominal noturna</label></div>
        <div class="checkbox-item"><input type="checkbox" id="alarm-hf"><label for="alarm-hf">Hist√≥ria familiar de c√¢ncer GI</label></div>
      </div>

      <div class="section-title">üìù 14. Observa√ß√µes Finais</div>
      <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="obs-qv"><label for="obs-qv">Impacto na qualidade de vida</label></div>
        <div class="checkbox-item"><input type="checkbox" id="obs-expect"><label for="obs-expect">Expectativa do paciente</label></div>
      </div>
      <textarea id="obs-outras" rows="3" placeholder="Outras informa√ß√µes relevantes..."></textarea>
    </div>
    <!-- ============ FIM SE√á√ÉO GASTROENTEROLOGIA ============ -->

      <button class="btn-generate" onclick="gerarRelatorio()">GERAR EVOLU√á√ÉO</button>
      <button class="btn-reset" onclick="limparTudo()">LIMPAR TUDO</button>
    </div>
  </div>

  <div id="modalResultado" class="modal">
    <div class="modal-content">
      <h2 style="color:var(--primary); text-align:center; margin-bottom:10px;">Relat√≥rio Final</h2>
      <textarea id="finalReport" readonly></textarea>
      <div class="modal-actions">
        <button class="btn-modal btn-copy" onclick="copiar()">Copiar Texto</button>
        <button class="btn-modal btn-pdf" onclick="salvarPDF()">Salvar PDF</button>
        <button class="btn-modal btn-close" onclick="fecharModal()">Fechar / Editar</button>
      </div>
    </div>
  </div>
  <script>

    // ============ FUN√á√ïES ESPECIALIDADES ============
    function abrirModalEspecialidades() {
      document.getElementById('modalEspecialidades').classList.add('active');
    }

    function fecharModalEspecialidades() {
      document.getElementById('modalEspecialidades').classList.remove('active');
    }

    function selecionarEspecialidade(tipo) {
      document.querySelectorAll('.secao-especializada').forEach(s => s.classList.remove('active'));

      if (tipo === 'gastro') {
        document.getElementById('secao-gastro').classList.add('active');
        setTimeout(() => {
          const elem = document.getElementById('secao-gastro');
          if(elem) elem.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }

      fecharModalEspecialidades();
    }

    function toggleDorAbdominal() {
      const checked = document.getElementById('dor-abdominal').checked;
      document.getElementById('dor-abdominal-detalhes').style.display = checked ? 'block' : 'none';
    }

    function toggleVomitos() {
      const checked = document.getElementById('vomitos').checked;
      document.getElementById('vomitos-detalhes').style.display = checked ? 'block' : 'none';
    }

    function toggleDisfagia() {
      const checked = document.getElementById('disfagia').checked;
      document.getElementById('disfagia-detalhes').style.display = checked ? 'block' : 'none';
    }

    function toggleDiarreia() {
      const checked = document.getElementById('diarreia').checked;
      document.getElementById('diarreia-detalhes').style.display = checked ? 'block' : 'none';
    }

    function toggleEtilismoGastro() {
      const checked = document.getElementById('hab-etil').checked;
      document.getElementById('etilismo-detalhes-gastro').style.display = checked ? 'block' : 'none';
    }

    window.addEventListener('load', function() {
      const modalEsp = document.getElementById('modalEspecialidades');
      if(modalEsp) {
        modalEsp.addEventListener('click', function(e) {
          if (e.target === this) {
            fecharModalEspecialidades();
          }
        });
      }
    });

    const state = {
      alergias: "N√£o",
      internacao: "N√£o",
      tabagismo: "N√£o",
      etilismo: "N√£o",
      drogas: "N√£o"
    };
    const alertTypes = new Set(["alergias","internacao","tabagismo","etilismo","drogas"]);

    function setOption(type, value){
      state[type] = value;
      const group = document.getElementById(type + "-group");
      const btns = group.getElementsByClassName("toggle-btn");
      Array.from(btns).forEach(b => {
        b.classList.remove("active");
        b.classList.remove("alert-active");
        if (b.innerText.trim().toUpperCase() === value.toUpperCase()){
          b.classList.add("active");
          if (value === "Sim" && alertTypes.has(type)) b.classList.add("alert-active");
        }
      });

      const detail = document.getElementById(type + "-detalhe");
      if (detail){
        detail.style.display = (value === "Sim") ? "block" : "none";
        if (value !== "Sim") detail.value = "";
        if (value === "Sim") detail.focus();
      }

      // bloco de c√°lculo tab√°gico
      if (type === "tabagismo"){
        const calcDiv = document.getElementById("tabagismo-calc");
        if (calcDiv){
          calcDiv.style.display = (value === "Sim") ? "block" : "none";
          if (value !== "Sim"){
            document.getElementById("tab_cigs_dia").value = "";
            document.getElementById("tab_anos").value = "";
            document.getElementById("tab_carga").innerText = "0";
          }
        }
      }
    }

    function v(id){
      const el = document.getElementById(id);
      return (el && el.value) ? el.value.trim() : "";
    }

    // c√°lculo carga tab√°gica: (cigarros/dia √∑ 20) √ó anos fumando [web:34][web:38]
    function calcularCargaTabagica(){
      const cigs = parseFloat(document.getElementById("tab_cigs_dia")?.value || "0");
      const anos = parseFloat(document.getElementById("tab_anos")?.value || "0");
      const span = document.getElementById("tab_carga");
      if (!span){
        return 0;
      }
      if (isNaN(cigs) || isNaN(anos) || cigs <= 0 || anos <= 0){
        span.innerText = "0";
        return 0;
      }
      const carga = (cigs / 20) * anos;
      const cargaFmt = carga.toFixed(1);
      span.innerText = cargaFmt;
      return carga;
    }

    const templates = {
      M: {
        ef_ectoscopia: "REG, regular estado nutricional, mucosas coradas e hidratadas, afebril, acian√≥tico, anict√©rico, l√∫cido e orientado (alo e autops√≠quico) em tempo e espa√ßo, comunicativo, eupneico, f√°cies at√≠pica.",
        ef_cp: "aus√™ncia de linfonodomegalias palp√°veis, aus√™ncia de turg√™ncia jugular, n√£o ausculto sopros carot√≠deos.",
        ef_acv: "RCR, BNF em 2T, sem sopros aud√≠veis. Ictus cordis n√£o palp√°vel. Pulsos presentes, amplos e sim√©tricos. TEC < 3s.",
        ef_ap: "MV+ bilateralamente aud√≠vel, sem ru√≠dos advent√≠cios. T√≥rax at√≠pico. Eupneico. Sem sinais de esfor√ßo.",
        ef_abd: "plano, fl√°cido, normotenso, sem visceromegalias, indolor, RHA+, DB negativa, sem peritonite.",
        ef_neuro: "ECG 15, pupilas isoc√≥ricas e fotorreagentes, MOE preservada, face sim√©trica, sem d√©ficits focais agudos, for√ßa e sensibilidade preservadas, coordena√ß√£o normal.",
        ef_membros: "sem edemas, panturrilhas livres, TEC < 3 segs.",
        neuro_detalhado: `N√≠vel de Consci√™ncia: Vigil e desperto, auto e alo orientado
Fala e linguagem preservadas, aus√™ncia de afasia e disartria.

Nervos cranianos: Pupilas isoc√≥ricas e fotorreagentes, MOE preservada, campimetria normal, face sim√©trica.

Motricidade: T√¥nus e trofismo preservado, for√ßa grau V global.

Sensibilidade: t√°til, t√©rmica, dolorosa e vibrat√≥ria preservadas.

Reflexos: grau 2 sim√©tricos. Cutaneoplantar em flex√£o bilateral.

Coordena√ß√£o: Eum√©trica. Romberg negativo. Sem sinais men√≠ngeos.`
      },
      F: {
        ef_ectoscopia: "REG, regular estado nutricional, mucosas coradas e hidratadas, afebril, acian√≥tica, anict√©rica, l√∫cida e orientada (alo e autops√≠quica) em tempo e espa√ßo, comunicativa, eupneica, f√°cies at√≠pica.",
        ef_cp: "aus√™ncia de linfonodomegalias palp√°veis, aus√™ncia de turg√™ncia jugular, n√£o ausculto sopros carot√≠deos.",
        ef_acv: "RCR, BNF em 2T, sem sopros aud√≠veis. Ictus cordis n√£o palp√°vel. Pulsos presentes, amplos e sim√©tricos. TEC < 3s.",
        ef_ap: "MV+ bilateralamente aud√≠vel, sem ru√≠dos advent√≠cios. T√≥rax at√≠pico. Eupneica. Sem sinais de esfor√ßo.",
        ef_abd: "plano, fl√°cido, normotenso, sem visceromegalias, indolor, RHA+, DB negativa, sem peritonite.",
        ef_neuro: "ECG 15, pupilas isoc√≥ricas e fotorreagentes, MOE preservada, face sim√©trica, sem d√©ficits focais agudos, for√ßa e sensibilidade preservadas, coordena√ß√£o normal.",
        ef_membros: "sem edemas, panturrilhas livres, TEC < 3 segs.",
        neuro_detalhado: `N√≠vel de Consci√™ncia: Vigil e desperta, auto e alo orientada
Fala e linguagem preservadas, aus√™ncia de afasia e disartria.

Nervos cranianos: Pupilas isoc√≥ricas e fotorreagentes, MOE preservada, campimetria normal, face sim√©trica.

Motricidade: T√¥nus e trofismo preservado, for√ßa grau V global.

Sensibilidade: t√°til, t√©rmica, dolorosa e vibrat√≥ria preservadas.

Reflexos: grau 2 sim√©tricos. Cutaneoplantar em flex√£o bilateral.

Coordena√ß√£o: Eum√©trica. Romberg negativo. Sem sinais men√≠ngeos.`
      }
    };

    const lastAuto = {};

    function initLastAuto(sexo){
      const t = templates[sexo] || templates.M;
      Object.keys(t).forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        lastAuto[id] = (el.value || "").trim();
      });
    }

    function aplicarGenero(sexo){
      const t = templates[sexo] || templates.M;
      Object.keys(t).forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const atual = (el.value || "").trim();
        const anterior = (lastAuto[id] || "").trim();
        if (atual === "" || atual === anterior){
          el.value = t[id];
          lastAuto[id] = t[id];
        }
      });
    }

    document.getElementById("sexo").addEventListener("change", (e) => {
      aplicarGenero(e.target.value);
    });

    function pad2(n){ return String(n).padStart(2, "0"); }

    function ensureMedsPrefix(){
      const ta = document.getElementById("meds_continuos");
      if (!ta) return;
      if (ta.value.trim() === "") ta.value = "01 - ";
    }

    function nextMedsIndex(text){
      const matches = text.match(/^(\d{2})\s*-\s*/gm);
      if (!matches || matches.length === 0) return 1;
      const last = matches[matches.length - 1];
      const n = parseInt(last, 10);
      return isNaN(n) ? (matches.length + 1) : (n + 1);
    }

    function handleMedsEnter(e){
      if (e.key !== "Enter") return;
      e.preventDefault();
      const ta = e.target;
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      const before = ta.value.slice(0, start);
      const after = ta.value.slice(end);
      const idx = nextMedsIndex(before);
      const insert = `\n${pad2(idx)} - `;
      ta.value = before + insert + after;
      const caret = (before + insert).length;
      ta.selectionStart = ta.selectionEnd = caret;
    }

    function initMedsField(){
      const ta = document.getElementById("meds_continuos");
      if (!ta) return;
      ensureMedsPrefix();
      ta.addEventListener("focus", ensureMedsPrefix);
      ta.addEventListener("keydown", handleMedsEnter);
    }

    function yesNoBoldLine(label, type){
      const valYN = state[type] === "Sim" ? "SIM" : "N√ÉO";
      const det = v(type + "-detalhe");
      return `**${label}: ${valYN}${det ? " ‚Äî " + det : ""}**`;
    }

    function habitLine(label, type){
      const sim = state[type] === "Sim";
      const det = v(type + "-detalhe");
      const yn = sim ? "**SIM**" : "N√ÉO";

      if (type === "tabagismo" && sim){
        const carga = calcularCargaTabagica();
        const extra = carga > 0 ? `, carga tab√°gica: ${carga.toFixed(1)} ma√ßos-ano` : "";
        return `${label}: ${yn}${det ? " (" + det + ")" : ""}${extra}`;
      }

      return `${label}: ${yn}${det ? " (" + det + ")" : ""}`;
    }
// ============ CAPTURAR DADOS GASTRO ============
function capturarDadosGastro() {
  const linhas = [];
  const gastroAtiva = document.getElementById('secao-gastro')?.classList.contains('active');
  if (!gastroAtiva) return linhas;
  
  linhas.push("");
  linhas.push("# ANAMNESE - GASTROENTEROLOGIA #");
  linhas.push("");
  
  // Fun√ß√£o auxiliar
  function getChecked(ids) {
    return ids.filter(id => document.getElementById(id)?.checked)
              .map(id => document.querySelector('label[for="' + id + '"]')?.textContent || id);
  }
  
  // Dor Abdominal
  if (document.getElementById('dor-abdominal')?.checked) {
    linhas.push("**DOR ABDOMINAL:**");
    const locs = getChecked(['loc-epigastrio','loc-hd','loc-he','loc-peri','loc-fid','loc-fie','loc-difusa']);
    if (locs.length > 0) linhas.push("  Localiza√ß√£o: " + locs.join(", "));
    const tipos = getChecked(['tipo-queimacao','tipo-colica','tipo-peso','tipo-pontada']);
    if (tipos.length > 0) linhas.push("  Tipo: " + tipos.join(", "));
    linhas.push("");
  }
  
  // Sintomas Digestivos
  const altos = getChecked(['azia','regurg','nauseas','odinofagia','saciedade','plenitude']);
  if (altos.length > 0) {
    linhas.push("**SINTOMAS DIGESTIVOS ALTOS:** " + altos.join(", "));
    linhas.push("");
  }
  
  const baixos = getChecked(['constipacao','alternancia','tenesmo','urgencia']);
  if (baixos.length > 0) {
    linhas.push("**SINTOMAS DIGESTIVOS BAIXOS:** " + baixos.join(", "));
    linhas.push("");
  }
  
  const fezes = getChecked(['fezes-normais','fezes-pastosas','fezes-liquidas','fezes-duras','fezes-melena','fezes-sangue','fezes-muco','fezes-oleosas']);
  if (fezes.length > 0) {
    linhas.push("**CARACTER√çSTICAS DAS FEZES:** " + fezes.join(", "));
    linhas.push("");
  }
  
  return linhas;
}

    function montarTextoRelatorioBase(){
      const linhas = [];
      linhas.push("## ADMISS√ÉO / EVOLU√á√ÉO ##");
      linhas.push("");
      linhas.push(`PACIENTE: ${v("nome")}`);
      linhas.push(`IDADE: ${v("idade")}    SEXO: ${v("sexo")}    RELIGI√ÉO: ${v("religiao")}`);
      if (v("unidade")) linhas.push(`UNIDADE/SETOR: ${v("unidade")}`);
      linhas.push("");
      linhas.push(yesNoBoldLine("ALERGIAS MEDICAMENTOSAS", "alergias"));
      linhas.push(yesNoBoldLine("INTERNA√á√ÉO NOS √öLTIMOS 3 MESES?", "internacao"));
      linhas.push("");
      linhas.push("**H√ÅBITOS DE VIDA:**");
      linhas.push(habitLine("Tabagismo", "tabagismo"));
      linhas.push(habitLine("Etilismo", "etilismo"));
      linhas.push(habitLine("Drogas il√≠citas", "drogas"));
      linhas.push("");
      linhas.push("**HIST√ìRIA PATOL√ìGICA PREGRESSA (HPP):**");
      linhas.push(v("hpp"));
      linhas.push("");
      linhas.push("**HIST√ìRIA FAMILIAR (HF):**");
      linhas.push(v("hf"));
      linhas.push("");
      linhas.push("**MEDICAMENTOS DE USO CONT√çNUO:**");
      linhas.push(v("meds_continuos"));
      linhas.push("");
      linhas.push("**EXAMES LABORATORIAIS:**");
      linhas.push(v("labs"));
      linhas.push("");
      linhas.push("**EXAMES DE IMAGEM:**");
      linhas.push (v("imagem"));
      linhas.push("");
      linhas.push("**QUEIXA PRINCIPAL (QP):**");
      linhas.push(v("qp"));
      linhas.push("");
      linhas.push("**HIST√ìRIA DA DOEN√áA ATUAL (HDA):**");
      linhas.push(v("hda"));
      linhas.push("");
      linhas.push("# EXAME F√çSICO #");
      linhas.push("Sinais Vitais");
      linhas.push(`PA: ${v("pa")} mmHg    FC: ${v("fc")} bpm    FR: ${v("fr")} ipm    SatO2: ${v("sat")}%    T: ${v("temp")}¬∞C    Glicemia: ${v("hgt")} mg/dL`);
      linhas.push("");
      linhas.push("**ECTOSCOPIA:**");
      linhas.push(v("ef_ectoscopia"));
      linhas.push("");
      linhas.push("**Cabe√ßa e pesco√ßo:**");
      linhas.push(v("ef_cp"));
      linhas.push("");
      linhas.push("**ACV:**");
      linhas.push(v("ef_acv"));
      linhas.push("");
      linhas.push("**AP:**");
      linhas.push(v("ef_ap"));
      linhas.push("");
      linhas.push("**ABD:**");
      linhas.push(v("ef_abd"));
      linhas.push("");
      linhas.push("**NEURO:**");
      linhas.push(v("ef_neuro"));
      linhas.push("");
      linhas.push("**MEMBROS:**");
      linhas.push(v("ef_membros"));
      linhas.push("");
      linhas.push("**EXAME NEUROL√ìGICO DETALHADO:**");
      linhas.push(v("neuro_detalhado"));
      linhas.push("");
      // Adicionar dados de Gastroenterologia
const dadosGastro = capturarDadosGastro();
dadosGastro.forEach(linha => linhas.push(linha));
      return linhas.join("\n");
    }

    function gerarRelatorio(){
      const texto = montarTextoRelatorioBase();
      document.getElementById("finalReport").value = texto;
      document.getElementById("modalResultado").style.display = "flex";
    }

    function fecharModal(){
      document.getElementById("modalResultado").style.display = "none";
    }

    function copiar(){
      const ta = document.getElementById("finalReport");
      ta.select();
      document.execCommand("copy");
      alert("Texto copiado!");
    }

  function salvarPDF(){
  const texto = document.getElementById("finalReport").value;
  const linhas = texto.split("\n");

  const now = new Date();
  const dataHora = now.toLocaleString("pt-BR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });

  const printWindow = window.open("", "_blank");

  function renderLinha(l){
    if (!l.trim()) return `<div class="space"></div>`;

    // T√≠tulo principal
    if (l.startsWith("##") && l.endsWith("##")){
      return `<h1>${l.replace(/#/g,"").trim()}</h1>`;
    }

    // Grande se√ß√£o
    if (l.startsWith("# ") && l.endsWith(" #")){
      return `<h2>${l.replace(/#/g,"").trim()}</h2>`;
    }

    // Subt√≠tulo em negrito
    if (l.startsWith("**") && l.endsWith("**")){
      return `<h3>${l.replace(/\*/g,"").trim()}</h3>`;
    }

    // Sinais vitais
    if (l.startsWith("PA:")){
      return `<div class="vitals">${l}</div>`;
    }

    return `<p>${l}</p>`;
  }

  printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Anamnese - ${v("nome")}</title>
<style>
.signature{
  margin-top: 40px;
  text-align: left;
}

.signature .line{
  width: 320px;
  border-top: 1.5px solid #000;
  margin-bottom: 6px;
}

.signature .label{
  font-size: 10.5pt;
  color: #333;
}

@page { margin: 1.5cm; }

body{
  font-family: Arial, Helvetica, sans-serif;
  font-size: 11.5pt;
  line-height: 1.5;
  color: #111;
}

.header{
  text-align: center;
  border-bottom: 2px solid #00695c;
  margin-bottom: 20px;
  padding-bottom: 10px;
}

.header h1{
  margin: 0;
  color: #00695c;
  font-size: 18pt;
}

.header .info{
  font-size: 10pt;
  margin-top: 4px;
}

h1{
  font-size: 16pt;
  margin: 20px 0 10px;
  color: #00695c;
}

h2{
  font-size: 14pt;
  margin: 18px 0 8px;
  border-left: 5px solid #00695c;
  padding-left: 8px;
}

h3{
  font-size: 12pt;
  margin: 14px 0 4px;
}

p{
  margin: 0 0 6px 0;
  text-align: justify;
}

.vitals{
  background: #f2f2f2;
  padding: 8px;
  margin: 10px 0;
  font-weight: bold;
  border-radius: 6px;
}

.space{
  height: 8px;
}

@media print{
  h1,h2,h3{ page-break-after: avoid; }
  p, .vitals{ page-break-inside: avoid; }
}
</style>
</head>

<body>
<div class="header">
  <h1>ANAMNESE FAST</h1>
  <div class="info">
    PACIENTE: ${v("nome")} | IDADE: ${v("idade")} | SEXO: ${v("sexo")}
  </div>
  ${v("unidade") ? `<div class="info">UNIDADE: ${v("unidade")}</div>` : ""}
  <div class="info">DATA/HORA: ${dataHora}</div>
</div>

${linhas.map(renderLinha).join("")}
<div class="signature">
  <div class="line"></div>
  <div class="label">Respons√°vel pelo preenchimento</div>
</div>

</body>
</html>
  `);

  printWindow.document.close();
  setTimeout(() => printWindow.print(), 400);
}

    function limparTudo(){
      if (!confirm("Deseja limpar todos os campos e iniciar uma nova anamnese?")) return;
      const sexoAtual = document.getElementById("sexo").value;
      document.getElementById("nome").value = "";
      document.getElementById("idade").value = "";
      document.getElementById("unidade").value = "";
      document.getElementById("religiao").value = "Cat√≥lico";
      setOption("alergias", "N√£o");
      setOption("internacao", "N√£o");
      setOption("tabagismo", "N√£o");
      setOption("etilismo", "N√£o");
      setOption("drogas", "N√£o");
      document.getElementById("hpp").value = "";
      document.getElementById("hf").value = "";
      document.getElementById("meds_continuos").value = "";
      document.getElementById("labs").value = "";
      document.getElementById("qp").value = "";
      document.getElementById("hda").value = "";
      document.getElementById("pa").value = "";
      document.getElementById("fc").value = "";
      document.getElementById("fr").value = "";
      document.getElementById("sat").value = "";
      document.getElementById("temp").value = "";
      document.getElementById("hgt").value = "";
      document.getElementById("tab_cigs_dia").value = "";
      document.getElementById("tab_anos").value = "";
      document.getElementById("tab_carga").innerText = "0";
      ["ef_ectoscopia","ef_cp","ef_acv","ef_ap","ef_abd","ef_neuro","ef_membros","neuro_detalhado"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      aplicarGenero(sexoAtual);
      initMedsField();
      ensureMedsPrefix();
      window.scrollTo({top: 0, behavior: "smooth"});
    }

    window.addEventListener("load", () => {
      const sexoAtual = document.getElementById("sexo").value;
      aplicarGenero(sexoAtual);
      initLastAuto(sexoAtual);
      initMedsField();
    });

// ========== SISTEMA DE LOGIN COM CADASTRO ==========
(function() {
  const CRED_KEY = 'anamnese_credentials';
  const SESSION_KEY = 'anamnese_auth_session';

  async function hashSenha(senha) {
    const encoder = new TextEncoder();
    const data = encoder.encode(senha);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  function salvarCredenciais(usuario, senhaHash) {
    try {
      localStorage.setItem(CRED_KEY, JSON.stringify({ usuario, senhaHash }));
    } catch (e) {
      console.error('Erro ao salvar credenciais:', e);
    }
  }

  function obterCredenciais() {
    try {
      const data = localStorage.getItem(CRED_KEY);
      return data ? JSON.parse(data) : null;
    } catch (e) {
      return null;
    }
  }

  function limparCredenciais() {
    try {
      localStorage.removeItem(CRED_KEY);
      sessionStorage.removeItem(SESSION_KEY);
    } catch (e) {
      console.error('Erro ao limpar credenciais:', e);
    }
  }

  function criarSessao() {
    try {
      sessionStorage.setItem(SESSION_KEY, '1');
    } catch (e) {
      console.error('Erro ao criar sess√£o:', e);
    }
  }

  function verificarSessao() {
    try {
      return sessionStorage.getItem(SESSION_KEY) === '1';
    } catch (e) {
      return false;
    }
  }

  function esconderLogin() {
    const overlay = document.getElementById('loginOverlay');
    if (overlay) overlay.style.display = 'none';
  }

  function mostrarLogin() {
    const overlay = document.getElementById('loginOverlay');
    if (overlay) overlay.style.display = 'flex';
  }

  function mostrarTela(tela) {
    ['telaLogin', 'telaCadastro', 'telaReset'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = id === tela ? 'block' : 'none';
    });
  }

  window.mostrarReset = function() {
    mostrarTela('telaReset');
  };

  window.voltarLogin = function() {
    mostrarTela('telaLogin');
    limparErros();
  };

  function limparErros() {
    const erros = ['loginErro', 'cadastroErro'];
    erros.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
  }

  function mostrarErro(id, mensagem) {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = mensagem;
      el.style.display = 'block';
    }
  }

  async function fazerLogin() {
    limparErros();
    
    const usuario = document.getElementById('loginUsuario')?.value?.trim();
    const senha = document.getElementById('loginSenha')?.value;

    if (!usuario || !senha) {
      mostrarErro('loginErro', 'Preencha usu√°rio e senha.');
      return;
    }

    const credenciais = obterCredenciais();
    if (!credenciais) {
      mostrarErro('loginErro', 'Nenhuma conta cadastrada.');
      return;
    }

    const senhaHash = await hashSenha(senha);

    if (usuario === credenciais.usuario && senhaHash === credenciais.senhaHash) {
      criarSessao();
      esconderLogin();
      inicializarApp();
    } else {
      mostrarErro('loginErro', 'Usu√°rio ou senha incorretos.');
    }
  }

  async function fazerCadastro() {
    limparErros();

    const usuario = document.getElementById('cadastroUsuario')?.value?.trim();
    const senha = document.getElementById('cadastroSenha')?.value;
    const senhaConfirm = document.getElementById('cadastroSenhaConfirm')?.value;

    if (!usuario || !senha || !senhaConfirm) {
      mostrarErro('cadastroErro', 'Preencha todos os campos.');
      return;
    }

    if (usuario.length < 3) {
      mostrarErro('cadastroErro', 'Usu√°rio deve ter pelo menos 3 caracteres.');
      return;
    }

    if (senha.length < 4) {
      mostrarErro('cadastroErro', 'Senha deve ter pelo menos 4 caracteres.');
      return;
    }

    if (senha !== senhaConfirm) {
      mostrarErro('cadastroErro', 'As senhas n√£o coincidem.');
      return;
    }

    const senhaHash = await hashSenha(senha);
    salvarCredenciais(usuario, senhaHash);
    criarSessao();
    esconderLogin();
    inicializarApp();
    alert(`‚úÖ Conta criada com sucesso! Bem-vindo, ${usuario}!`);
  }

  function resetarCredenciais() {
    if (confirm('‚ö†Ô∏è Tem certeza? Isso apagar√° seu usu√°rio e senha atuais.')) {
      limparCredenciais();
      alert('‚úÖ Credenciais resetadas. Voc√™ pode criar uma nova conta.');
      location.reload();
    }
  }

  function inicializarApp() {
    try {
      const sexoAtual = document.getElementById('sexo')?.value || 'M';
      if (typeof window.initLastAuto === 'function') window.initLastAuto(sexoAtual);
      if (typeof window.aplicarGenero === 'function') window.aplicarGenero(sexoAtual);
      if (typeof window.initMedsField === 'function') window.initMedsField();
    } catch (e) {
      console.warn('Erro ao inicializar app:', e);
    }
  }

  function inicializarLogin() {
    const credenciais = obterCredenciais();

    if (!credenciais) {
      mostrarTela('telaCadastro');
      mostrarLogin();
      setTimeout(() => {
        const cadastroUsuario = document.getElementById('cadastroUsuario');
        if (cadastroUsuario) cadastroUsuario.focus();
      }, 100);
    } else if (verificarSessao()) {
      esconderLogin();
      inicializarApp();
    } else {
      mostrarTela('telaLogin');
      mostrarLogin();
      setTimeout(() => {
        const loginUsuario = document.getElementById('loginUsuario');
        if (loginUsuario) loginUsuario.focus();
      }, 100);
    }

    const btnLogin = document.getElementById('loginEntrar');
    if (btnLogin) btnLogin.addEventListener('click', fazerLogin);

    const btnCadastro = document.getElementById('cadastroBotao');
    if (btnCadastro) btnCadastro.addEventListener('click', fazerCadastro);

    const btnReset = document.getElementById('resetConfirmar');
    if (btnReset) btnReset.addEventListener('click', resetarCredenciais);

    const loginSenha = document.getElementById('loginSenha');
    if (loginSenha) {
      loginSenha.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') fazerLogin();
      });
    }

    const cadastroSenhaConfirm = document.getElementById('cadastroSenhaConfirm');
    if (cadastroSenhaConfirm) {
      cadastroSenhaConfirm.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') fazerCadastro();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', inicializarLogin);
})();

// ========== HIST√ìRICO DE PACIENTES ==========
(function () {
  const HISTORICO_KEY = 'anamnese_historico';

  function gerarId() {
    return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  function obterPacientes() {
    try {
      const data = localStorage.getItem(HISTORICO_KEY);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      console.warn('Erro ao carregar hist√≥rico:', e);
      return [];
    }
  }

  function salvarPacientes(pacientes) {
    try {
      localStorage.setItem(HISTORICO_KEY, JSON.stringify(pacientes));
    } catch (e) {
      console.warn('Erro ao salvar hist√≥rico:', e);
    }
  }

  function coletarDadosPaciente() {
    const fieldIds = [
      'responsavel', 'nome', 'idade', 'sexo', 'religiao', 'unidade',
      'alergias-detalhe', 'internacao-detalhe',
      'tabagismo-detalhe', 'tabcigsdia', 'tabanos',
      'etilismo-detalhe', 'drogas-detalhe',
      'qp', 'hda', 'hpp', 'medscontinuos', 'hf', 'labs', 'imagem',
      'pa', 'fc', 'fr', 'sat', 'temp', 'hgt',
      'efectoscopia', 'efcp', 'efacv', 'efap', 'efabd', 'efneuro', 'efmembros',
      'neurodetalhado'
    ];

    const data = { fields: {}, toggles: {} };

    fieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        data.fields[id] = el.value || '';
      }
    });

    const toggleStates = ['alergias', 'internacao', 'tabagismo', 'etilismo', 'drogas'];
    toggleStates.forEach(key => {
      if (typeof state !== 'undefined' && state[key]) {
        data.toggles[key] = state[key];
      } else {
        data.toggles[key] = 'No';
      }
    });

    return data;
  }

  window.salvarPacienteAtual = function () {
    const nome = document.getElementById('nome')?.value?.trim();
    
    if (!nome) {
      alert('‚ö†Ô∏è Digite o nome do paciente antes de salvar!');
      return;
    }

    const dados = coletarDadosPaciente();
    const pacientes = obterPacientes();

    const paciente = {
      id: gerarId(),
      nome: nome,
      idade: dados.fields.idade || '',
      sexo: dados.fields.sexo || 'M',
      unidade: dados.fields.unidade || '',
      queixa: dados.fields.qp || '',
      dataSalvo: new Date().toISOString(),
      dados: dados
    };

    pacientes.unshift(paciente);
    salvarPacientes(pacientes);

    alert(`‚úÖ Paciente "${nome}" salvo com sucesso!`);
    atualizarListaPacientes();
  };

  function carregarPaciente(dados) {
    if (!confirm('‚ö†Ô∏è Isso substituir√° os dados atuais. Deseja continuar?')) {
      return;
    }

    if (dados.fields) {
      Object.keys(dados.fields).forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.value = dados.fields[id] || '';
        }
      });
    }

    if (dados.toggles) {
      Object.keys(dados.toggles).forEach(key => {
        const value = dados.toggles[key];
        if (typeof window.setOption === 'function') {
          try {
            window.setOption(key, value);
          } catch (e) {
            console.warn('Erro ao restaurar toggle:', key, e);
          }
        }
      });
    }

    if (typeof window.calcularCargaTabagica === 'function') {
      try {
        window.calcularCargaTabagica();
      } catch (e) {
        console.warn('Erro ao calcular carga tab√°gica:', e);
      }
    }

    const sexo = document.getElementById('sexo')?.value;
    if (sexo && typeof window.aplicarGenero === 'function') {
      try {
        window.aplicarGenero(sexo);
      } catch (e) {
        console.warn('Erro ao aplicar g√™nero:', e);
      }
    }

    fecharHistorico();
    alert('‚úÖ Dados do paciente carregados!');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function excluirPaciente(id) {
    if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir este paciente do hist√≥rico?')) {
      return;
    }

    let pacientes = obterPacientes();
    pacientes = pacientes.filter(p => p.id !== id);
    salvarPacientes(pacientes);
    atualizarListaPacientes();
    alert('‚úÖ Paciente exclu√≠do do hist√≥rico');
  }

  function formatarData(isoString) {
    try {
      const data = new Date(isoString);
      return data.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      return 'Data inv√°lida';
    }
  }

  function atualizarListaPacientes(filtro = '') {
    const lista = document.getElementById('listaPacientes');
    const count = document.getElementById('pacientesCount');
    
    if (!lista) return;

    const pacientes = obterPacientes();
    const filtroLower = filtro.toLowerCase();
    const pacientesFiltrados = filtro 
      ? pacientes.filter(p => p.nome.toLowerCase().includes(filtroLower))
      : pacientes;

    if (count) {
      count.textContent = `${pacientesFiltrados.length} paciente${pacientesFiltrados.length !== 1 ? 's' : ''} ${filtro ? 'encontrado' : 'salvo'}${pacientesFiltrados.length !== 1 ? 's' : ''}`;
    }

    if (pacientesFiltrados.length === 0) {
      lista.innerHTML = `
        <div class="empty-state">
          <p>üì≠</p>
          <p>${filtro ? 'Nenhum paciente encontrado' : 'Nenhum paciente salvo ainda'}</p>
        </div>
      `;
      return;
    }

    lista.innerHTML = pacientesFiltrados.map(p => `
      <div class="paciente-item">
        <div class="paciente-item-header">
          <div class="paciente-nome">${p.nome || 'Sem nome'}</div>
          <div class="paciente-data">${formatarData(p.dataSalvo)}</div>
        </div>
        <div class="paciente-info">
          ${p.idade ? `${p.idade} anos` : ''} ${p.idade && p.sexo ? '‚Ä¢' : ''} ${p.sexo === 'M' ? 'Masculino' : 'Feminino'}
          ${p.unidade ? ` ‚Ä¢ ${p.unidade}` : ''}
        </div>
        ${p.queixa ? `<div class="paciente-info" style="font-style: italic; color: #777;">QP: ${p.queixa.substring(0, 60)}${p.queixa.length > 60 ? '...' : ''}</div>` : ''}
        <div class="paciente-actions">
          <button class="btn-carregar" onclick="window.carregarPacienteById('${p.id}')">üìÇ Carregar</button>
          <button class="btn-excluir" onclick="window.excluirPacienteById('${p.id}')">üóëÔ∏è Excluir</button>
        </div>
      </div>
    `).join('');
  }

  window.carregarPacienteById = function (id) {
    const pacientes = obterPacientes();
    const paciente = pacientes.find(p => p.id === id);
    if (paciente) {
      carregarPaciente(paciente.dados);
    }
  };

  window.excluirPacienteById = function (id) {
    excluirPaciente(id);
  };

  window.abrirHistorico = function () {
    const modal = document.getElementById('modalHistorico');
    if (modal) {
      modal.classList.add('show');
      atualizarListaPacientes();
      
      setTimeout(() => {
        const search = document.getElementById('searchPaciente');
        if (search) search.focus();
      }, 100);
    }
  };

  window.fecharHistorico = function () {
    const modal = document.getElementById('modalHistorico');
    if (modal) {
      modal.classList.remove('show');
      const search = document.getElementById('searchPaciente');
      if (search) search.value = '';
    }
  };

  window.addEventListener('load', function () {
    const btnHistorico = document.getElementById('btnHistorico');
    if (btnHistorico) {
      btnHistorico.addEventListener('click', abrirHistorico);
    }

    const searchInput = document.getElementById('searchPaciente');
    if (searchInput) {
      searchInput.addEventListener('input', function (e) {
        atualizarListaPacientes(e.target.value);
      });
    }

    const originalGerarRelatorio = window.gerarRelatorio;
    if (typeof originalGerarRelatorio === 'function') {
      window.gerarRelatorio = function () {
        originalGerarRelatorio();
        
        setTimeout(() => {
          if (confirm('üíæ Deseja salvar este paciente no hist√≥rico?')) {
            window.salvarPacienteAtual();
          }
        }, 500);
      };
    }
  });
})();
  </script>
    <!-- MODAL DE ESPECIALIDADES -->
  <div id="modalEspecialidades" class="modal-especialidades">
    <div class="modal-content-esp">
      <h2>üè• Selecione a Especialidade</h2>
      <div class="especialidade-item" onclick="selecionarEspecialidade('gastro')">
        üî• Gastroenterologia
      </div>
      <div class="especialidade-item" onclick="alert('Em breve!')">
        ‚ù§Ô∏è Cardiologia (Em breve)
      </div>
      <div class="especialidade-item" onclick="alert('Em breve!')">
        ü´Å Pneumologia (Em breve)
      </div>
      <div class="especialidade-item" onclick="alert('Em breve!')">
        üß† Neurologia (Em breve)
      </div>
      <button class="btn-fechar-modal" onclick="fecharModalEspecialidades()">Fechar</button>
    </div>
  </div>
</body>
</html>